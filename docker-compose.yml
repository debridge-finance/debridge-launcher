version: "3.6"
services:
  postgres:
    image: postgres
    container_name: postgres${DOCKER_ID}
    restart: on-failure
    env_file:
      - .env
    volumes:
      - ./pgdata:/var/lib/postgresql/data
      - ./pg-init-scripts:/docker-entrypoint-initdb.d
    networks:
      - debridge-node-network
  ipfs-daemon:
    image: debridgefinance/ipfs-daemon:v1.1.2
    container_name: ipfs-daemon${DOCKER_ID}
    command: daemon --writable --enable-pubsub-experiment
    restart: always
    volumes:
      - ./data/ipfs:/data/ipfs
    networks:
      - debridge-node-network
  orbitdb:
    image: debridgefinance/orbitdb:v1.1.2
    container_name: orbitdb${DOCKER_ID}
    command: node dist/main ${ORBITDB_NODE_OPTIONS}
    restart: on-failure
    volumes:
      - ./data/orbitdb:/home/node/orbitdb
      - ./stats/orbitdb:/home/node/stats
      - ./config:/home/node/dist/config
    environment:
      - PORT=${ORBITDB_PORT}
      - SENTRY_DSN=${SENTRY_DSN}
      - JWT_SECRET=${ORBITDB_JWT_SECRET}
      - ORBITDB_LOGIN=${ORBITDB_LOGIN}
      - ORBITDB_PASSWORD=${ORBITDB_PASSWORD}
      - IPFS_URL=${IPFS_URL}
      - IPFS_DAEMON_HOST=ipfs-daemon
      - IPFS_DAEMON_PORT=5001
      - NODE_OPTIONS=${ORBITDB_NODE_OPTIONS}
    depends_on:
      - ipfs-daemon
    networks:
      - debridge-node-network
  debridge-node:
    build: debridge_node
    # image: debridgefinance/debridge-node:v1.1.2
    container_name: debridge-node${DOCKER_ID}
    command: node dist/src/main ${DEBRIDGE_NODE_NODE_OPTIONS}
    restart: on-failure
    secrets:
      - source: keystore
        target: /home/node/keystore.json
    volumes:
      - ./data/orbitdb:/home/node/orbitdb
      - ./stats/debridge-node:/home/node/stats
      - ./config:/home/node/dist/src/config
    environment:
      - PORT=${DEBRIDGE_NODE_PORT}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DATABASE=${POSTGRES_DATABASE}
      - POSTGRES_PORT=${POSTGRES_PORT}
      - KEYSTORE_PASSWORD=${KEYSTORE_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
      - API_BASE_URL=${API_BASE_URL}
      - API_LOGIN=${API_LOGIN}
      - API_PASSWORD=${API_PASSWORD}
      - IPFS_URL=${IPFS_URL}
      - SENTRY_DSN=${SENTRY_DSN}
      - ORBITDB_LOGIN=${ORBITDB_LOGIN}
      - ORBITDB_PASSWORD=${ORBITDB_PASSWORD}
      - ORBITDB_URL=${ORBITDB_URL}
      - NODE_OPTIONS=${DEBRIDGE_NODE_NODE_OPTIONS}
    depends_on:
      - postgres
      - orbitdb
    networks:
      - debridge-node-network
networks:
  debridge-node-network:
    name: debridge-node-network
secrets:
  keystore:
    file: ./secrets/keystore.json